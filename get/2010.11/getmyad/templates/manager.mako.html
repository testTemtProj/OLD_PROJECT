# -*- coding: utf-8 -*-
<%inherit file="/main.mako.html" />	
<%!
from getmyad.model import Permission, Account, ManagerReports
%>
<%def name="head()">
        <title>Статистика GetMyAd</title>
		<link type="text/css" href="/lib/css/theme/jquery-ui-1.8.1.custom.css" rel="stylesheet" />
		<link type="text/css" href="/lib/grid/css/ui.jqgrid.css" rel="stylesheet" />
		<link type="text/css" href="/css/main.css" rel="stylesheet" />
		<script type="text/javascript" src="/lib/jquery/jquery-1.4.2.min.js"></script>
		<script type="text/javascript" src="/lib/ui/jquery-ui-1.8.1.custom.min.js"></script>
		<script type="text/javascript" src="/lib/grid/js/i18n/grid.locale-ru.js" ></script>		
		<script type="text/javascript" src="/lib/grid/js/jquery.jqGrid.min.js" ></script>		
		<script type="text/javascript" src="/lib/ui/i18n/ui.datepicker-ru.js"></script>
		<script type="text/javascript" src="/lib/plugins/jquery.form.js"></script>
</%def>
##%>	4parser

##		<script type="text/javascript" src="/lib/grid/src/grid.loader.js" ></script>

<div id="loading" style="width: 100%; margin-top: 100px; text-align: center;">
	<img src="/img/wait26trans.gif" /> <br /> Загрузка...
</div>

<script type="text/javascript">
	var currentClickCost = ${currentClickCost};
	var dataMoneyOutRequests = ${c.dataMoneyOutRequests};
	var dataUsersSummary = ${dataUsersSummary};
	var dataDomainRequests = ${c.domainsRequests};
	var dataOverallSummary = ${c.dataOverallSummary};
	var managersSummary = ${c.managersSummary};
	var notApprovedRequests = ${c.notApprovedRequests};	
	var permissionSetClickCost = ${'true' if c.permission.has(Permission.SET_CLICK_COST) else 'false'};
	var permissionViewMoneyOut = ${'true' if c.permission.has(Permission.VIEW_MONEY_OUT) else 'false'};
	var permissionViewAllUserStats = ${'true' if c.permission.has(Permission.VIEW_ALL_USERS_STATS) else 'false'};
	var permissionRegisterUserAccount = ${h.JSON(True if c.permission.has(Permission.REGISTER_USERS_ACCOUNT) else False)};
	var moneyOutHistory = ${c.moneyOutHistory};
	var token = ${h.JSON(c.token)};	
% if c.account.account_type == Account.Manager:
    var monthProfitPerDate = ${ManagerReports(c.account).monthProfitPerDate()};
% endif
  var dataUsersImpressions = ${c.dataUsersImpressions}
</script>
<script type="text/javascript" src="/js/manager.js"></script>


<style type="text/css">
	#dialogSetCost label, #dialogSetCost input, #dialogSetPercent input, #dialogSetPercent label{
		display: block;
	}
	
	#dialogSetCost input, #dialogSetPercent input {
		margin-bottom: 10px;
	}
	
	#dialogSetCost fieldset, #dialogSetPercent fieldset {
		padding:0;
		border:0;
		margin-top:15px; 
	}
	#dialogSetCost_user, #dialogSetPercent_manager {
		font-weight: bold;
	}
	
	a.redflag:link {
	  color: red;
	}
	a.greenflag:link {
	  color: green;
	}
	a.orangeflag:link{
	  color: grey;
	}
	
	tr.jqgrow td {white-space: normal;}		/* Multiline rows for jqGrid */
</style>


<div id="tabs" style="min-height: 500px; min-width: 1200px; visibility: hidden;" >
<ul>
	<li><a href="#main">Обзор</a></li>
	
% if c.permission.has(Permission.VIEW_MONEY_OUT):
	<li><a href="#moneyOutRequests" id="href_moneyOutRequests" name="href_moneyOutRequests">Вывод средств</a></li>
%endif
% if c.permission.has(Permission.USER_DOMAINS_MODERATION):
	<li><a href="#moderation" id="href_moderation" name="href_moderation">Модерация</a></li>
% endif	
% if c.account.account_type == Account.Manager:	
	<li id="linkaccount"><a href="#money_account">Счёт</a></li>
%endif
% if c.account.account_type == Account.Administrator:
  <li><a href="#stat_transfer_from_partners">Переходы от партнёров</a></li>
% endif
<!--% if c.account.account_type == Account.Administrator:-->
	<li><a href="#addstat">Скрипт сбора статистики</a></li>
<!--% endif-->
</ul>
<div id="main">
	<h2> Сегодня ${c.date}</h2>
	
<% 
	service_links = []
	if c.permission.has(Permission.REGISTER_USERS_ACCOUNT):
		service_links.append(('/register_adv/index', u'Регистрация аккаунта пользователя GetMyAd'))
	if c.permission.has(Permission.MANAGE_USER_INFORMERS):   
		service_links.append(('/advertise/showList', u'Расширенная настройка информеров'))
	service_links.append(('/manager/checkInformers/UA', u'Проверка работоспособности информеров'))  
%>
${' | '.join(['<a href="%s" target="_blank">%s</a>' % x for x in service_links]) }

% if c.permission.has(Permission.VIEW_ALL_USERS_STATS):
	<h2> Сводная информация по менеджерам</h2>
	<table id="managersSummary"></table>
% endif
	
	
	<h2> Статистика GetMyAd</h2>
	<table id="statistic_data" cellspacing="10">
	  <tr>
	  	<td>Всего аккаунтов партнёрской сети: </td>
		<td><b>${c.acc_count}</b></td>
	  </tr>
	  <tr>
	  	<td>Всего активных аккаунтов:  </td>
		<td> <b> ${c.act_acc_count}   </b> </td>
		<td> <font color="grey"/><I>  (вчера ${c.act_acc_count_yesterday}, позавчера ${c.act_acc_count_b_yesterday})</I></td>

	  </tr>	
	</table>  
	
	Данные статистики актуальны на   <b>${c.usersSummaryActualTime}</b>
% if c.account.account_type == Account.Administrator:
	<p/>
	<table id="tableOverallSummary"></table>
	<div id="pagerOverallSummary"></div>
% endif
	<p/>
	<table id="tableUsersSummary"></table>
	<p/>
	<p/>
	<table id="tableUsersImpressions"> </table>

	
		
	<h2>Текущие цены за уникального посетителя</h2>
	<div id="toolbarClickCost"></div>
	<table id="tableClickCost"></table>
	
	<br/><br/>
	


</div>

<div id="moneyOut" class="dialog">
  <style type="text/css">           /* Форма вывода денег */
    form label {    display: block; }
    form input {  
      display: block;
      margin-bottom: 10px;
      width: 200px;}
  </style>
  <form name="moneyOut_form" id="moneyOut_form" action="/manager/moneyOutSubmit" method="get" >
          <input type="hidden" name="token" id="token" value="${c.token}"/>
          <h2>Заявка на вывод средств</h2>
          <fieldset id="moneyOut">
            <label for="moneyOut_summ">Сумма для разового вывода</label>
            <input type="text" id="moneyOut_summ" name="moneyOut_summ" />
            
            <label for="moneyOut_comment">Примечания</label>
            <textarea rows="4" cols="50" id="moneyOut_comment" name="moneyOut_comment"></textarea>
          </fieldset>
            
            <div id="moneyOut_errorMessage" class="errorMessage"></div>
          
            <div id="moneyOut_wait" style="text-align: right; display: none;" >
              <img src="/img/wait26trans.gif" />
            </div>
            
   </form>      
</div>




% if c.permission.has(Permission.VIEW_MONEY_OUT):
<div id="moneyOutRequests">
	<table cellspacing="10">
	<tr>
	  <td>Количество активных заявок, ожидающих одобрения:</td>
	  <td><b id="notApprovedRequests" name="notApprovedRequests"> ${c.notApprovedRequests}</b></td>
	    
	</tr>  
	<tr>  
	  	<td>Сумма доступная к выводу на сегодня: </td>
		  <td><b> ${h.formatMoney(c.sum_out['total'])}</b>
		  <span id="sumMoneyOutDetails" style="color: gray; margin-left: 2em;">
		  		<b>(WebmoneyZ:</b> ${h.formatMoney(c.sum_out['webmoney_z'])} | 
				<b>Карточка:</b> ${h.formatMoney(c.sum_out['card'])} | 
				<b>Счёт-фактура:</b> ${h.formatMoney(c.sum_out['factura'])} |
				<b>Неопределено:</b> ${h.formatMoney(c.sum_out['unknown'])})
		  </span>
		  <br />
		  </td>
	 </tr>
	 <tr>
  	 	<td> Прогноз суммы доступной к выводу к 10му числу:</td>
  		<td><b> ${c.prognoz_sum_out}</b></td>
	 </tr>
	 </table>
	
	<h2>Заявки на вывод средств</h2>
	
	<div id="toolbarMoneyOutRequest"></div>
	<table id="tableMoneyOutRequest"></table>
	
</div>
%endif

<div id="moderation">
% if c.permission.has(Permission.USER_DOMAINS_MODERATION):
	<h2>Ожидают модерации</h2>
	<table id="tableDomainRegistration"></table>
%endif
</div>

<div id="money_account">
% if c.account.account_type == Account.Manager:
  <h2> Операции со счётом</h2>
  <div id="managerBalanceInfo">
    <table>
      <tr>
        <td>Текущий процент:</td>
        <td><b>${ManagerReports(c.account).currentPercent()}</b></td>
      </tr>
      <tr>
        <td>Сумма на счету:</td>
        <td><b>${h.formatMoney(ManagerReports(c.account).balance())}</b></td>
      </tr>
      <tr>
        <td>Доход за последние 30 дней:</td>
        <td><b>${h.formatMoney(ManagerReports(c.account).monthBalance())}</b></td>
      </tr>
      <tr>
        <td>Оформить заявку на <a href="javascript:void(0)" class="linkMoneyOut">вывод средств</a>.
        </td>  
      </tr>
      <tr>
        <table id="tableAccountMoneyOut"></table>
        <div id="pagerAccountMoneyOut"></div>
      </tr> 
      <tr>
        <p/>
        <table id="tableAccountProfit"> </table>
      </tr>     
    </table>
	
  </div>
  
  <div id="dialogCancelRequest" title="" style="display: none;">
        <p>Вы действительно хотите отменить заявку?</p>
  </div>
% endif
  
</div>  



<div id="dialogSetPercent" style="display: none;" title="Назначение процента">
	Назначить процент пользователю <span id="dialogSetPercent_manager">%manager%</span>
	<form>   
		<fieldset>
			<label for="dialogSetPercent_percent">Процент</label>
			<input type="text" name="dialogSetPercent_percent" id="dialogSetPercent_percent" class="text ui-widget-content ui-corner-all"/>
		</fieldset>
	</form>
</div>

<div id="dialogSetCost" style="display: none;" title="Назначение цены">
	Назначить цену пользователю <span id="dialogSetCost_user">%username%</span>
	<form>
		<fieldset>
			<label for="dialogSetCost_cost">Цена</label>
			<input type="text" name="dialogSetCost_cost" id="dialogSetCost_cost" class="text ui-widget-content ui-corner-all"/>
			
			<label for="dialogSetCost_date">Время применения:</label>
			<input type="text" name="dialogSetCost_date" id="dialogSetCost_date" value="" readonly="true" class="text ui-widget-content ui-corner-all" />
		</fieldset>
	</form>
</div>



<div id="dialogMoneyOutApprove" style="display: none;" title="Одобрение заявки на вывод средств">
	Вы действительно хотите перевести <span id="dialogMoneyOutApprove_summ" style="font-weight: bold;"></span> на счёт пользователя <span id="dialogMoneyOutApprove_user" style="font-weight: bold;"></span>?
	<span id="dialogMoneyOutApprove_date" style="display:none;"></span>
</div>

% if c.account.account_type == Account.Administrator:
<div id="stat_transfer_from_partners">
	<H3>Статистика эффективности партнерских каналов: </H3>
<table >
	<tr valign="top">
		<td >
				<div style="margin:5px 5px 5px 5px">C					
				<input type="text" id="calendar1" value="" />
				По 
				<input type="text" id="calendar2" value="" />
			<div/>
		</td>
		<td>
			<div><p><input type="checkbox" id="check_percent" title="Показывать в процентах показы в процентном соотношении"/>Показывать в процентах(%)</p></div>
		</td>
	</tr>
	</table><table>
	<tr valign="top">
	<td><table id="table_user"></table>

</td>
	<td>
	<table id="le_table"></table>
	<div id="le_pager2"></div>
	</td>
</tr>
</table>
<table>
<tr><br />
	<td>
	<table id="le_table_all" ></table>
</td></tr>
</table>	
</div>  
% endif
<!--% if c.account.account_type == Account.Administrator:-->
<div id="addstat">
	<table cellspacing="10px">
		<tr valign="top">
			<td >
				Адрес сайта:
					<br />
				<input type="text" id="site_url" style="width:320px;">	
				</input>
					<br />
				<input type="button" id="btnCodeGen" value="Получить код"/>
					<br />
				Код для вставки:
					<br />	
				<textarea id="StatCode" style="width:320px;height:180px;"></textarea>				
			</td>
			<td >
			<div id="list_domain" >
			Сайты установившие скрипт:
			<br />	
				<select id="domain_with_script" multiple style="width:320px; height: 260px">				
				</select>
			</div>
			</td>
		</tr>	
	</table>
</div>
<!--% endif-->
</div>	<!-- end #tabs -->


<script type="text/javascript">
	ManagerUI();
</script>
