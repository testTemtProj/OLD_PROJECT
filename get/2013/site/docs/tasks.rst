Задачи Celery
=============

process_click (Обработка клика)
-------------------------------

Обработка клика пользователя по рекламному предложению.

Задача ставится в очередь скриптом redirect.py или выполняется немедленно при
недоступности Celery.

В процессе обработки:

1. IP ищется в чёрном списке.

2. Проверяется, что по ссылке переходит тот же ip, которому она была
   выдана.

3. Проверяется, что ссылка ещё не устарела.

4. Если ip сделал больше трёх переходов за сутки, ip заносится в чёрный
   список.

5. Клик передаётся в AdLoad.

6. Только если все предыдущие пункты отработали нормально, клик
   записывается в GetMyAd. В противном случае, делается запись либо
   в ``clicks.rejected`` (отклонённые клики), либо в ``clicks.error``
   (клики, во время обработки которых произошла ошибка).


clean_ip_blacklist (Чистка чёрного списка IP)
---------------------------------------------

Удаляет старые записи из чёрного списка. Старыми считаются записи, по которым
не было нарушений в течении четёрых недель.

Вызывается раз в сутки.


decline_unconfirmed_moneyout_requests
-------------------------------------

Отклоняет заявки, которые пользователи не подтвердили в течении трёх дней.

Задача вызывается каждые 8 часов.


agregate_stats (Обработка статистики)
-------------------------------------

Составляет общую статистику по предприятию с разбивкой по датам.

Вызывается каждые 30 минут.


archive_old_stats (Архивация статистики)
----------------------------------------

Помещает старую статистику в архив (базу данных getmyad_archive).

Без этого статистика сильно разростается и индексы начинают занимать всю
доступную оперативную память.

Вызывается раз в сутки.


check_outdated_campaigns
------------------------

Иногда AdLoad не оповещает GetMyAd об остановке кампании, об отработке
парсера и т.д. Это приводит к тому, что кампания продолжает крутиться
в GetMyAd, но клики не засчитываются и записываются в ``clicks.error``.
Данная задача проверяет, не произошло ли за последнее время несколько
таких ошибок и, если произошло, обновляет кампанию.

Вызывается раз в 10 минут.
